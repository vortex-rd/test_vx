var DesSerializadorDeFiltros={desSerializarFiltro:function(un_filtro_serializado){var filtro;switch(un_filtro_serializado.tipo){case"EX":filtro=new FiltroXEjemplo;break;case"EQ":filtro=new FiltroXClaveValor;break;case"AND":filtro=new FiltroAND;break;case"OR":filtro=new FiltroOR;break;case"TRUE":filtro=new FiltroTrue;break;case"FALSE":filtro=new FiltroFalse;break;default:filtro=new FiltroDesconocido}filtro.desSerializar(un_filtro_serializado);return filtro}};if(typeof require!="undefined"){exports.DesSerializadorDeFiltros=DesSerializadorDeFiltros}var FiltroXEjemplo=function(ejemplo){this.ejemplo=ejemplo};FiltroXEjemplo.prototype={evaluarMensaje:function(un_mensaje){for(var prop in this.ejemplo){if(typeof un_mensaje[prop]=="object"){var filtro_por_ejemplo=new FiltroXEjemplo(this.ejemplo[prop]);if(!filtro_por_ejemplo.evaluarMensaje(un_mensaje[prop]))return false}if(this.ejemplo[prop]!=un_mensaje[prop])return false}return true},serializar:function(){return{tipo:"EX",ejemplo:this.ejemplo}},desSerializar:function(un_filtro_serializado){this.ejemplo=un_filtro_serializado.ejemplo},simplificar:function(){return this},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroXEjemplo))return false;return this.ejemplo==otro_filtro.ejemplo}};if(typeof require!="undefined"){exports.FiltroXEjemplo=FiltroXEjemplo}var FiltroXClaveValor=function(clave,valor){this._clave=clave;this._valor=valor};FiltroXClaveValor.prototype={evaluarMensaje:function(un_mensaje){return un_mensaje[this._clave]==this._valor},serializar:function(){return{tipo:"EQ",clave:this._clave,valor:this._valor}},desSerializar:function(un_filtro_serializado){this._clave=un_filtro_serializado.clave;this._valor=un_filtro_serializado.valor},simplificar:function(){return this},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroXClaveValor))return false;return this._clave==otro_filtro._clave&&this._valor==otro_filtro._valor}};if(typeof require!="undefined"){exports.FiltroXClaveValor=FiltroXClaveValor}var DesSerializadorDeTrafos={desSerializarTrafo:function(una_trafo_serializada){var trafo;switch(una_trafo_serializada.tipo){case"COMP":trafo=new TrafoCompuesta;break;case"KEYVALUE":trafo=new TrafoXClaveValor;break}trafo.desSerializar(una_trafo_serializada);return trafo}};if(typeof require!="undefined"){exports.DesSerializadorDeTrafos=DesSerializadorDeTrafos}var TrafoXClaveValor=function(clave,valor){this.clave=clave;this.valor=valor};TrafoXClaveValor.prototype={transformarMensaje:function(un_mensaje){un_mensaje[this.clave]=this.valor;return un_mensaje},serializar:function(){return{tipo:"KEYVALUE",clave:this.clave,valor:this.valor}},desSerializar:function(una_trafo_serializada){this.clave=una_trafo_serializada.clave;this.valor=una_trafo_serializada.valor}};if(typeof require!="undefined"){exports.TrafoXClaveValor=TrafoXClaveValor}var TrafoCompuesta=function(trafos){this.trafos=trafos===undefined?[]:trafos};TrafoCompuesta.prototype={transformarMensaje:function(un_mensaje){for(var i=0;i<this.trafos.length;i++){this.trafos[i].transformarMensaje(un_mensaje)}return un_mensaje},serializar:function(){var ret={tipo:"COMP",trafos:[]};for(var i=0;i<this.trafos.length;i++){ret.trafos.push(this.trafos[i].serializar())}return ret},desSerializar:function(una_trafo_serializada){for(var i=0;i<una_trafo_serializada.trafos.length;i++){this.trafos.push(DesSerializadorDeTrafos.desSerializarTrafo(una_trafo_serializada.trafos[i]))}}};if(typeof require!="undefined"){exports.TrafoCompuesta=TrafoCompuesta}var FiltroAND=function(_filtros){this.filtros=_filtros===undefined?[]:_filtros};FiltroAND.prototype={evaluarMensaje:function(un_mensaje){var valorRetorno=true;for(var i=0;i<this.filtros.length;i++){var evaluacion=this.filtros[i].evaluarMensaje(un_mensaje);if(evaluacion==false){return false}if(evaluacion===undefined){valorRetorno=undefined}}return valorRetorno},serializar:function(){var ret={tipo:"AND",filtros:[]};for(var i=0;i<this.filtros.length;i++){ret.filtros.push(this.filtros[i].serializar())}return ret},desSerializar:function(un_filtro_serializado){for(var i=0;i<un_filtro_serializado.filtros.length;i++){this.filtros.push(DesSerializadorDeFiltros.desSerializarFiltro(un_filtro_serializado.filtros[i]))}},simplificar:function(){var filtros_acumulados_simplificados=[];for(var i=0;i<this.filtros.length;i++){if(this.filtros[i]instanceof FiltroAND){for(var j=0;j<this.filtros[i].filtros.length;j++){filtros_acumulados_simplificados.push(this.filtros[i].filtros[j].simplificar())}}else{filtros_acumulados_simplificados.push(this.filtros[i].simplificar())}}var filtros_sin_true=[];for(var i=0;i<filtros_acumulados_simplificados.length;i++){if(filtros_acumulados_simplificados[i]instanceof FiltroFalse)return filtros_acumulados_simplificados[i];if(!(filtros_acumulados_simplificados[i]instanceof FiltroTrue))filtros_sin_true.push(filtros_acumulados_simplificados[i])}if(filtros_sin_true.length==1)return filtros_sin_true[0];if(filtros_sin_true.length==0)return new FiltroFalse;return new FiltroAND(filtros_sin_true).eliminarDuplicados()},eliminarDuplicados:function(){var filtro_sin_duplicados=new FiltroAND;for(var i=0;i<this.filtros.length;i++){if(!filtro_sin_duplicados.incluyeElFiltro(this.filtros[i])){filtro_sin_duplicados.filtros.push(this.filtros[i])}}return filtro_sin_duplicados},incluyeElFiltro:function(un_filtro){for(var i=0;i<this.filtros.length;i++){if(this.filtros[i].equals(un_filtro))return true}return false},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroAND))return false;if(otro_filtro.filtros.length!=this.filtros.length)return false;for(var i=0;i<this.filtros.length;i++){if(!otro_filtro.incluyeElFiltro(this.filtros[i]))return false}return true}};if(typeof require!="undefined"){exports.FiltroAND=FiltroAND}var FiltroOR=function(_filtros){this.filtros=_filtros===undefined?[]:_filtros};FiltroOR.prototype={evaluarMensaje:function(un_mensaje){var valorRetorno=false;for(var i=0;i<this.filtros.length;i++){var evaluacion=this.filtros[i].evaluarMensaje(un_mensaje);if(evaluacion==true){return true}if(evaluacion===undefined){valorRetorno=undefined}}return valorRetorno},serializar:function(){var ret={tipo:"OR",filtros:[]};for(var i=0;i<this.filtros.length;i++){ret.filtros.push(this.filtros[i].serializar())}return ret},desSerializar:function(un_filtro_serializado){for(var i=0;i<un_filtro_serializado.filtros.length;i++){this.filtros.push(DesSerializadorDeFiltros.desSerializarFiltro(un_filtro_serializado.filtros[i]))}},simplificar:function(){var filtros_acumulados_simplificados=[];for(var i=0;i<this.filtros.length;i++){if(this.filtros[i]instanceof FiltroOR){for(var j=0;j<this.filtros[i].filtros.length;j++){filtros_acumulados_simplificados.push(this.filtros[i].filtros[j].simplificar())}}else{filtros_acumulados_simplificados.push(this.filtros[i].simplificar())}}var filtros_sin_false=[];for(var i=0;i<filtros_acumulados_simplificados.length;i++){if(filtros_acumulados_simplificados[i]instanceof FiltroTrue)return filtros_acumulados_simplificados[i];if(!(filtros_acumulados_simplificados[i]instanceof FiltroFalse))filtros_sin_false.push(filtros_acumulados_simplificados[i])}var filtro_a_devolver=new FiltroOR(filtros_sin_false).eliminarDuplicados();if(filtro_a_devolver.filtros.length==1)return filtros_sin_false[0];if(filtro_a_devolver.filtros.length==0)return new FiltroFalse;return filtro_a_devolver},eliminarDuplicados:function(){var filtro_sin_duplicados=new FiltroOR;for(var i=0;i<this.filtros.length;i++){if(!filtro_sin_duplicados.incluyeElFiltro(this.filtros[i])){filtro_sin_duplicados.filtros.push(this.filtros[i])}}return filtro_sin_duplicados},incluyeElFiltro:function(un_filtro){for(var i=0;i<this.filtros.length;i++){if(this.filtros[i].equals(un_filtro))return true}return false},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroOR))return false;if(otro_filtro.filtros.length!=this.filtros.length)return false;for(var i=0;i<this.filtros.length;i++){if(!otro_filtro.incluyeElFiltro(this.filtros[i]))return false}return true}};if(typeof require!="undefined"){exports.FiltroOR=FiltroOR}var FiltroDesconocido=function(){this.version_serializada={tipo:"?"}};FiltroDesconocido.prototype={evaluarMensaje:function(un_mensaje){return undefined},onChange:function(observador){this._observador=observador},serializar:function(){return this.version_serializada},desSerializar:function(un_filtro_serializado){this.version_serializada=un_filtro_serializado},simplificar:function(){return this}};if(typeof require!="undefined"){exports.FiltroDesconocido=FiltroDesconocido}var FiltroTrue=function(){};FiltroTrue.prototype={evaluarMensaje:function(un_mensaje){return true},onChange:function(observador){this._observador=observador},serializar:function(){var ret={tipo:"TRUE"};return ret},desSerializar:function(un_filtro_serializado){},simplificar:function(){return this},equals:function(otro_filtro){return otro_filtro instanceof FiltroTrue}};if(typeof require!="undefined"){exports.FiltroTrue=FiltroTrue}var FiltroFalse=function(){};FiltroFalse.prototype={evaluarMensaje:function(un_mensaje){return false},onChange:function(observador){this._observador=observador},serializar:function(){var ret={tipo:"FALSE"};return ret},desSerializar:function(un_filtro_serializado){},simplificar:function(){return this},equals:function(otro_filtro){return otro_filtro instanceof FiltroFalse}};if(typeof require!="undefined"){exports.FiltroFalse=FiltroFalse}var NodoClienteHTTP=function(p){this.url=p.url;this.intervalo_polling=p.intervalo_polling||1500;this.verbose=p.verbose||false;this.mensajes_por_paquete=p.mensajes_por_paquete||100;this.alDesconectar=p.alDesconectar||function(){};this.start()};NodoClienteHTTP.prototype.start=function(){this.intervaloPedidoIdSesion=5e3;this.bandejaSalida=[];this.receptor={recibirMensaje:function(un_mensaje){}};this.pedirIdSesion()};NodoClienteHTTP.prototype.pedirIdSesion=function(){var _this=this;$.ajax({type:"POST",url:_this.url+"/create",xhrFields:{withCredentials:false},success:function(responseData,textStatus,jqXHR){_this.idSesion=responseData;if(_this.verbose)console.log("idSesion:",_this.idSesion);setTimeout(function(){_this.enviarYRecibirMensajes()},_this.intervaloPolling)},error:function(request,error){console.log("errorAlPedirSesion:",error);setTimeout(function(){_this.pedirIdSesion()},_this.intervaloPedidoIdSesion)}})};NodoClienteHTTP.prototype.enviarYRecibirMensajes=function(){var _this=this;var cant_mensajes_a_enviar;var bandejaSalidaAux=[];cant_mensajes_a_enviar=this.bandejaSalida.length;if(cant_mensajes_a_enviar>=this.mensajes_por_paquete)cant_mensajes_a_enviar=this.mensajes_por_paquete;bandejaSalidaAux=this.bandejaSalida.splice(0,cant_mensajes_a_enviar);var datosSalida={contenidos:bandejaSalidaAux,proximaEsperaMinima:0,proximaEsperaMaxima:3e5};if(bandejaSalidaAux.length>0){if(_this.verbose)console.log("enviando:",bandejaSalidaAux)}$.ajax({type:"POST",url:_this.url+"/session/"+_this.idSesion,xhrFields:{withCredentials:false},data:{mensajes_vortex:JSON.stringify(datosSalida)},success:function(responseData,textStatus,jqXHR){var mensajesRecibidos=$.parseJSON(responseData).contenidos;mensajesRecibidos.forEach(function(element,index,array){if(_this.verbose)console.log("mensaje recibido:",element);_this.receptor.recibirMensaje(element)});setTimeout(function(){_this.enviarYRecibirMensajes()},_this.intervaloPolling)},error:function(request,error){console.log("error Al Enviar/Recibir Mensajes:",error);_this.bandejaSalida=bandejaSalidaAux.concat(_this.bandejaSalida);_this.desconectarDe(_this.receptor)}})};NodoClienteHTTP.prototype.recibirMensaje=function(un_mensaje){this.bandejaSalida.push(un_mensaje)};NodoClienteHTTP.prototype.conectarCon=function(un_receptor){this.receptor=un_receptor};NodoClienteHTTP.prototype.desconectarDe=function(un_nodo){this.receptor={recibirMensaje:function(){},desconectarDe:function(){}};this.desconectarDe=function(){};un_nodo.desconectarDe(this);if(this.verbose)console.log("socket "+this.id+" desconectado");this.alDesconectar()};if(typeof require!="undefined"){exports.clase=NodoClienteHTTP}var ClonadorDeObjetos={clonarObjeto:function(obj){if(typeof obj==="object"){if(obj===null){return null}if(obj instanceof Array){return this.extend([],obj)}else if(obj instanceof Date){var t=new obj.constructor;t.setTime(obj.getTime());return t}else{return this.extend({},obj)}}return obj},hop:Object.prototype.hasOwnProperty,extend:function(a,b,context,newobjs,aparent,aname,haveaparent){if(a==b){return a}if(!b){return a}var key,clean_context=false,return_sublevel=false,b_pos;if(!haveaparent){aparent={a:a};aname="a"}if(!context){clean_context=true;context=[];newobjs=[]}b_pos=context.indexOf(b);if(b_pos==-1){context.push(b);newobjs.push([aparent,aname])}else{return newobjs[b_pos][0][newobjs[b_pos][1]]}for(key in b){if(this.hop.call(b,key)){if(typeof a[key]==="undefined"){if(typeof b[key]==="object"){if(b[key]instanceof Array){a[key]=this.extend([],b[key],context,newobjs,a,key,true)}else if(b[key]===null){a[key]=null}else if(b[key]instanceof Date){a[key]=new b[key].constructor;a[key].setTime(b[key].getTime())}else{a[key]=this.extend({},b[key],context,newobjs,a,key,true)}}else{a[key]=b[key]}}else if(typeof a[key]==="object"&&a[key]!==null){a[key]=this.extend(a[key],b[key],context,newobjs,a,key,true)}else{a[key]=b[key]}}}if(clean_context){context=null;newobjs=null}if(!haveaparent){aparent=null;return a}if(typeof a==="object"&&!(a instanceof Array)){}return a}};if(typeof require!="undefined"){exports.clase=ClonadorDeObjetos}var GeneradorDeIdMensaje=function(){this.start()};GeneradorDeIdMensaje.prototype.start=function(){this.numeroSecuencia=0;this.idEmisor=Math.floor(Math.random()*1e4+1).toString()};GeneradorDeIdMensaje.prototype.ponerIdAlMensaje=function(un_mensaje){this.numeroSecuencia++;var idMensaje={id_del_emisor:this.idEmisor,numero_secuencia:this.numeroSecuencia};un_mensaje.id_mensaje_vortex=idMensaje};if(typeof require!="undefined"){exports.clase=GeneradorDeIdMensaje}if(typeof require!="undefined"){var GeneradorDeIdMensaje=require("./GeneradorDeIdMensaje").clase;var PataConectora=require("./PataConectora").clase;var FiltroOR=require("./FiltrosYTransformaciones").FiltroOR;var FiltroAND=require("./FiltrosYTransformaciones").FiltroAND}var NodoPortalBidi=function(aliasPortal){this._listaPedidos=[];this._pata=new PataConectora(0,new GeneradorDeIdMensaje);this._alias_portal="portal "+aliasPortal};NodoPortalBidi.prototype.publicarFiltros=function(){var filtros=[];this._listaPedidos.forEach(function(p){filtros.push(p.filtro)});var filtroMergeado=new FiltroOR(filtros).simplificar();this._pata.publicarFiltro(filtroMergeado)};NodoPortalBidi.prototype.enviarMensaje=function(un_mensaje){this._pata.recibirMensaje(un_mensaje)};NodoPortalBidi.prototype.pedirMensajes=function(filtro,callback){this._listaPedidos.push({filtro:filtro,callback:callback});this.publicarFiltros()};NodoPortalBidi.prototype.recibirMensaje=function(un_mensaje){if(un_mensaje.tipoDeMensaje!==undefined){if(un_mensaje.tipoDeMensaje.slice(0,"Vortex.".length)=="Vortex."){this._pata.recibirMensaje(un_mensaje);return}}this._listaPedidos.forEach(function(pedido){if(pedido.filtro.evaluarMensaje(un_mensaje)){pedido.callback(un_mensaje)}})};NodoPortalBidi.prototype.conectarCon=function(un_receptor){this._pata.conectarCon(un_receptor)};NodoPortalBidi.prototype.conectarBidireccionalmenteCon=function(otro_nodo){this.conectarCon(otro_nodo);otro_nodo.conectarCon(this)};NodoPortalBidi.prototype.conectadoBidireccionalmente=function(){return this._pata.conectadaBidireccionalmente()};NodoPortalBidi.prototype.filtroDeSalida=function(){return this._pata.filtroRecibido()};if(typeof require!="undefined"){exports.clase=NodoPortalBidi}if(typeof require!="undefined"){var GeneradorDeIdMensaje=require("./GeneradorDeIdMensaje").clase;var PataConectora=require("./PataConectora").clase;var FiltroOR=require("./FiltrosYTransformaciones").FiltroOR;var FiltroAND=require("./FiltrosYTransformaciones").FiltroAND;var FiltroFalse=require("./FiltrosYTransformaciones").FiltroFalse}var NodoRouter=function(aliasRouter){this._patas=[];this._proximoIdPata=0;this._generadorDeIdMensaje=new GeneradorDeIdMensaje;this._aliasRouter="router "+aliasRouter};NodoRouter.prototype.mergearFiltrosParaUnaPata=function(pata){var filtrosParaLaPata=[];this._patas.forEach(function(p){if(p===pata)return;filtrosParaLaPata.push(p.filtroRecibido())});var filtroAPublicarALaPata=new FiltroFalse;if(filtrosParaLaPata.length>0){filtroAPublicarALaPata=new FiltroOR(filtrosParaLaPata).simplificar()}pata.publicarFiltro(filtroAPublicarALaPata)};NodoRouter.prototype.mergearYEnviarFiltros=function(){var self=this;this._patas.forEach(function(pata){self.mergearFiltrosParaUnaPata(pata)})};NodoRouter.prototype.enviarMensajeATodasLasPatas=function(un_mensaje){this._patas.forEach(function(pata){pata.recibirMensaje(un_mensaje)})};NodoRouter.prototype.recibirMensaje=function(un_mensaje){this.enviarMensajeATodasLasPatas(un_mensaje)};NodoRouter.prototype.conectarCon=function(un_receptor){var nuevaPata=new PataConectora(this._proximoIdPata,this._generadorDeIdMensaje);this._proximoIdPata+=1;this._patas.push(nuevaPata);nuevaPata.conectarCon(un_receptor);var _this=this;nuevaPata.onFiltroRecibidoModificado=function(){_this.mergearYEnviarFiltros()}};NodoRouter.prototype.desconectarDe=function(un_receptor){var pata;for(var i=0;i<this._patas.length;i++){if(this._patas[i]._receptor===un_receptor){pata=this._patas[i];pata.desconectar()}}if(pata){un_receptor.desconectarDe(this);this._patas.splice(this._patas.indexOf(pata),1);this.mergearYEnviarFiltros()}};NodoRouter.prototype.conectarBidireccionalmenteCon=function(un_nodo){this.conectarCon(un_nodo);un_nodo.conectarCon(this)};NodoRouter.prototype.conectadoBidireccionalmenteEnTodasSusPatas=function(){var conectado=true;this._patas.forEach(function(pata){if(!pata.conectadaBidireccionalmente())conectado=false});return conectado};NodoRouter.instancia=new NodoRouter("singleton");if(typeof require!="undefined"){exports.clase=NodoRouter}if(typeof require!="undefined"){var FiltroTrue=require("./FiltrosYTransformaciones").FiltroTrue;var FiltroFalse=require("./FiltrosYTransformaciones").FiltroFalse;var FiltroOR=require("./FiltrosYTransformaciones").FiltroOR;var FiltroAND=require("./FiltrosYTransformaciones").FiltroAND;var DesSerializadorDeFiltros=require("./FiltrosYTransformaciones").DesSerializadorDeFiltros;var ClonadorDeObjetos=require("./ClonadorDeObjetos").clase}var PataConectora=function(idLocalPata,generadorDeIdMensaje,aliasNodo){this._generadorDeIdMensaje=generadorDeIdMensaje;this._idLocal=idLocalPata;this._idRemoto;this._idPedidoEnviado;this._filtroRecibido=new FiltroTrue;this._filtroEnviado=new FiltroFalse;this._filtroAEnviar;this._laPataEsBidireccional=false;this._receptor={recibirMensaje:function(un_mensaje){}};this.publicarFiltro=this.publicarFiltro_cuandoLaPataNoEsBidi;this._alias_nodo=aliasNodo;this.onFiltroRecibidoModificado=function(){}};PataConectora.prototype={elMensajeEsParaEstaPata:function(un_mensaje){return this._idLocal==un_mensaje.idLocalAlReceptor},enviarMensaje:function(un_mensaje){var mensaje_a_enviar=ClonadorDeObjetos.clonarObjeto(un_mensaje);if(!(this._idRemoto===undefined))mensaje_a_enviar.idLocalAlReceptor=this._idRemoto;var self=this;setTimeout(function(){self._receptor.recibirMensaje(mensaje_a_enviar)},0);return mensaje_a_enviar},enviarMensajePropio:function(un_mensaje){this._generadorDeIdMensaje.ponerIdAlMensaje(un_mensaje);var mensaje_enviado=this.enviarMensaje(un_mensaje);return mensaje_enviado},recibirPublicacionDeFiltro:function(una_publicacion){if(!this.elMensajeEsParaEstaPata(una_publicacion))return;this._filtroRecibido=DesSerializadorDeFiltros.desSerializarFiltro(una_publicacion.filtro).simplificar();this.onFiltroRecibidoModificado()},enviarPedidoDeIdRemoto:function(){var pedido={tipoDeMensaje:"Vortex.IdRemoto.Pedido"};this.enviarMensajePropio(pedido);this._idPedidoEnviado=pedido.id_mensaje_vortex},recibirPedidoDeIdRemoto:function(un_pedido){var respuesta={tipoDeMensaje:"Vortex.IdRemoto.Respuesta",idLocalAlEmisor:this._idLocal,idPedidoOriginal:un_pedido.id_mensaje_vortex};this.enviarMensajePropio(respuesta)},recibirRespuestaAPedidoDeIdRemoto:function(una_respuesta){if(this.compararIdsMensajes(una_respuesta.idPedidoOriginal,this._idPedidoEnviado)){this._idRemoto=una_respuesta.idLocalAlEmisor;var confirmacion={tipoDeMensaje:"Vortex.IdRemoto.Confirmacion",idLocalAlEmisor:this._idLocal};this.enviarMensajePropio(confirmacion)}},compararIdsMensajes:function(id1,id2){if(id1===undefined||id2===undefined)return false;return id1.id_del_emisor==id2.id_del_emisor&&id1.numero_secuencia==id2.numero_secuencia},recibirConfirmacionDePedidoDeIdRemoto:function(una_confirmacion){if(this.elMensajeEsParaEstaPata(una_confirmacion)){this._idRemoto=una_confirmacion.idLocalAlEmisor;var reConfirmacion={tipoDeMensaje:"Vortex.IdRemoto.ReConfirmacion",idLocalAlEmisor:this._idLocal};this.enviarMensajePropio(reConfirmacion);if(!this._laPataEsBidireccional)this.laPataSeHizoBiDireccional()}},recibirReConfirmacionDePedidoDeIdRemoto:function(una_re_confirmacion){if(this.elMensajeEsParaEstaPata(una_re_confirmacion)){if(!this._laPataEsBidireccional)this.laPataSeHizoBiDireccional()}},publicarFiltro_cuandoLaPataEsBidi:function(filtro){if(filtro.equals(this._filtroEnviado))return;var publicacionDeFiltro={tipoDeMensaje:"Vortex.Filtro.Publicacion",filtro:filtro.serializar()};var mensaje_enviado=this.enviarMensajePropio(publicacionDeFiltro);this._filtroEnviado=filtro},publicarFiltro_cuandoLaPataNoEsBidi:function(filtro){this._filtroAEnviar=filtro},laPataSeHizoBiDireccional:function(){this._filtroRecibido=new FiltroFalse;this.onFiltroRecibidoModificado();this.publicarFiltro=this.publicarFiltro_cuandoLaPataEsBidi;if(!(this._filtroAEnviar===undefined))this.publicarFiltro(this._filtroAEnviar);this._laPataEsBidireccional=true},filtrarYEnviarMensaje:function(un_mensaje){if(un_mensaje.idLocalAlReceptor==this._idLocal)return;if(!this._filtroRecibido.evaluarMensaje(un_mensaje))return;var mensaje_enviado;if(un_mensaje.id_mensaje_vortex===undefined)mensaje_enviado=this.enviarMensajePropio(un_mensaje);else mensaje_enviado=this.enviarMensaje(un_mensaje)},filtroRecibido:function(){return this._filtroRecibido},recibirMensaje:function(un_mensaje){switch(un_mensaje.tipoDeMensaje){case"Vortex.IdRemoto.Pedido":this.recibirPedidoDeIdRemoto(un_mensaje);break;case"Vortex.IdRemoto.Respuesta":this.recibirRespuestaAPedidoDeIdRemoto(un_mensaje);break;case"Vortex.IdRemoto.Confirmacion":this.recibirConfirmacionDePedidoDeIdRemoto(un_mensaje);break;case"Vortex.IdRemoto.ReConfirmacion":this.recibirReConfirmacionDePedidoDeIdRemoto(un_mensaje);break;case"Vortex.Filtro.Publicacion":this.recibirPublicacionDeFiltro(un_mensaje);break;default:this.filtrarYEnviarMensaje(un_mensaje)}},conectarCon:function(un_receptor){this._receptor=un_receptor;this.enviarPedidoDeIdRemoto()},desconectar:function(){this._receptor={recibirMensaje:function(un_mensaje){}}},conectadaBidireccionalmente:function(){return this._laPataEsBidireccional}};if(typeof require!="undefined"){exports.clase=PataConectora}var NodoConectorSocket=function(opt){this.socket=opt.socket;this.verbose=opt.verbose||false;this.id=opt.id||"anonimo";this.alDesconectar=opt.alDesconectar||function(){};this.start()};NodoConectorSocket.prototype.start=function(){var _this=this;this.socket.on("mensaje_vortex",function(mensaje){if(_this.verbose)console.log("conector recibe mensaje por socket:",mensaje);_this.receptor.recibirMensaje(mensaje)});this.socket.on("disconnect",function(){_this.desconectarDe(_this.receptor)});if(this.verbose)console.log("socket "+this.id+" conectado")};NodoConectorSocket.prototype.conectarCon=function(un_nodo){this.receptor=un_nodo};NodoConectorSocket.prototype.desconectarDe=function(un_nodo){this.receptor={recibirMensaje:function(){},desconectarDe:function(){}};this.desconectarDe=function(){};un_nodo.desconectarDe(this);if(this.verbose)console.log("socket "+this.id+" desconectado");this.alDesconectar()};NodoConectorSocket.prototype.recibirMensaje=function(mensaje){if(this.verbose)console.log("conector envia mensaje por socket:",mensaje);this.socket.emit("mensaje_vortex",mensaje)};if(typeof require!="undefined"){exports.clase=NodoConectorSocket}if(typeof require!="undefined"){var NodoRouter=require("./NodoRouter").clase;var NodoConectorSocket=require("./NodoConectorSocket").clase;var NodoPortalBidi=require("./NodoPortalBidi").clase;var cryptico=require("cryptico");var io=require("socket.io-client");exports.GeneradorDeIdMensaje=require("./GeneradorDeIdMensaje").clase;exports.ClonadorDeObjetos=require("./ClonadorDeObjetos").clase;exports.PataConectora=require("./PataConectora").clase;exports.FiltrosYTransformaciones=require("./FiltrosYTransformaciones");exports.NodoMultiplexor=require("./NodoMultiplexor").clase;exports.NodoRouter=NodoRouter;exports.NodoPortalBidi=NodoPortalBidi;exports.NodoPortalBidiMonoFiltro=require("./NodoPortalBidiMonoFiltro").clase;exports.NodoConectorSocket=NodoConectorSocket;exports.NodoConectorHttpServer=require("./NodoConectorHttpServer").clase}var Vortex=Vx=vX=vx={start:function(opt){this.verbose=opt.verbose;this.router=new NodoRouter;this.claveRSAComun=cryptico.generateRSAKey("VORTEXCAPO",1024);this.clavePublicaComun=cryptico.publicKeyString(this.claveRSAComun);this.portales=[];this.keys=[];this.lastRequest=0;this.conexion_web},conectarPorHTTP:function(p){if(this.conexion_web){this.conexion_web.alDesconectar=function(){};this.conexion_web.desconectarDe(this.router);this.adaptadorWebSockets={}}var _this=this;p.verbose=this.verbose;p.alDesconectar=function(){_this.conectarPorHTTP(p)};this.adaptadorHTTP=new NodoClienteHTTP(p);this.router.conectarBidireccionalmenteCon(this.adaptadorHTTP);this.conexion_web=this.adaptadorHTTP},conectarPorWebSockets:function(p){if(this.conexion_web){this.conexion_web.alDesconectar=function(){};this.conexion_web.desconectarDe(this.router);this.adaptadorHTTP={}}var _this=this;var socket=io.connect(p.url);this.adaptadorWebSockets=new NodoConectorSocket({id:"1",socket:socket,verbose:this.verbose,alDesconectar:function(){_this.conectarPorWebSockets(p)}});this.router.conectarBidireccionalmenteCon(this.adaptadorWebSockets);this.conexion_web=this.adaptadorWebSockets},conectarPorBluetoothConArduino:function(p){this.adaptadorArduino=new NodoAdaptadorBluetoothArduino(p);this.router.conectarBidireccionalmenteCon(this.adaptadorArduino)},pedirMensajes:function(p){var filtro=p.filtro;if(p.filtro.evaluarMensaje===undefined)filtro=new FiltroXEjemplo(p.filtro);var portal=new NodoPortalBidi("portal"+this.portales.length);portal.conectarBidireccionalmenteCon(this.router);portal.pedirMensajes(filtro,p.callback);this.portales.push(portal);return this.portales.length-1},pedirMensajesSeguros:function(p,claveRSA){var _this=this;return this.pedirMensajes({filtro:p.filtro,callback:function(mensaje){var mi_clave_privada=_this.claveRSAComun;var su_clave_publica=_this.clavePublicaComun;if(mensaje.para)mi_clave_privada=claveRSA;if(mensaje.de)su_clave_publica=mensaje.de;if(mensaje.datoSeguro){var desencriptado=cryptico.decrypt(mensaje.datoSeguro,mi_clave_privada);if(desencriptado.status=="success"){mensaje.datoSeguro=JSON.parse(desencriptado.plaintext);if(desencriptado.signature=="verified"){if(su_clave_publica==desencriptado.publicKeyString){p.callback(mensaje)}}}}else{p.callback(mensaje)}}})},enviarMensaje:function(mensaje){this.router.recibirMensaje(mensaje)},enviarMensajeSeguro:function(mensaje,claveRSA){var mi_clave_privada=this.claveRSAComun;var su_clave_publica=this.clavePublicaComun;if(mensaje.de)mi_clave_privada=claveRSA;if(mensaje.para)su_clave_publica=mensaje.para;if(mensaje.datoSeguro){mensaje.datoSeguro=cryptico.encrypt(JSON.stringify(mensaje.datoSeguro),su_clave_publica,mi_clave_privada).cipher}this.router.recibirMensaje(mensaje)},addKey:function(){var claveRSA=null;if(typeof arguments[0]=="object"){claveRSA=arguments[0]}else if(typeof arguments[0]=="string"){claveRSA=cryptico.generateRSAKey(arguments[0],1024)}var clavePublica=cryptico.publicKeyString(claveRSA);this.keys[clavePublica]=claveRSA;return clavePublica},send:function(){var _this=this;var obj=null;var callback=null;var claveRSA=null;obj=arguments[0];if(arguments.length==2){callback=arguments[1]}if(callback&&obj.de){obj.idRequest=++this.lastRequest;var idPortal=this.when({responseTo:obj.idRequest,para:obj.de},function(objRespuesta){callback(objRespuesta);_this.portales.splice(idPortal,1)})}if(obj.de){claveRSA=this.keys[obj.de];this.enviarMensajeSeguro(obj,claveRSA);return}if(!obj.de&&obj.para){this.enviarMensajeSeguro(obj);return}this.enviarMensaje(obj)},when:function(){var _filtro=arguments[0];var _callback=arguments[1];if(_filtro.para){return this.pedirMensajesSeguros({filtro:_filtro,callback:_callback},this.keys[_filtro.para])}if(_filtro.de&&!_filtro.para){return this.pedirMensajesSeguros({filtro:_filtro,callback:_callback})}return this.pedirMensajes({filtro:_filtro,callback:_callback})}};if(typeof require!="undefined"){exports.Vortex=Vortex}